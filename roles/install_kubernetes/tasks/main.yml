---

- name: set SystemdCgroup to true
  replace:
    path: /etc/containerd/config.toml
    regexp: '(SystemdCgroup = false)'
    replace: 'SystemdCgroup = true'

# calls for restart of containerd  ?? move to install containerd?
# TODO restart containerd

- name: uninstall dphys-swapfile
  apt:
    name: dphys-swapfile
    state: absent

- name: check for swap
  command: swapon -s
  register: swap_present
  changed_when: False

- name: turn off swap
  command: dphys-swapfile swapoff
  when: swap_present.stdout != ""

- name: disable swap at boot
  service:
    name: dphys-swapfile
    enabled: no
  when: swap_present.stdout != ""

- name: update the cache if older than 6 hours
  apt:
    cache_valid_time: 21600

- name: install kube pre-requsites
  apt:
    name: "{{ packages }}"
  vars:
    packages:
    - apt-transport-https
    - ca-certificates
    - curl
    state: present

- name: add apt signing key for kubernetes
  apt_key:
    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
    state: present

- name: add kubernetes repo
  apt_repository:
    repo: deb http://apt.kubernetes.io/ kubernetes-xenial main
    state: present

# TODO only if repo was added
- name: update the cache
  apt:
   update_cache: yes

- name: install kubeadm, kubelet, and kubectl
  apt:
    name: "{{ packages }}"
  vars:
    packages:
    - kubeadm={{ kubeadm_version }}
    - kubelet={{ kubelet_version }}
    - kubectl={{ kubectl_version }}
    state: present
